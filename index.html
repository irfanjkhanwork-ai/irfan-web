<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Irfan Portal — Essays (embedded / external)</title>
  <style>
    :root{--bg:#f7f4e0;--teal:#78cbb3;--card:#fff;--muted:#666;--link:#0b5ed7;--maxw:1100px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP","Hiragino Kaku Gothic ProN",sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:var(--maxw);margin:12px auto;padding:12px;display:flex;gap:18px}
    nav.sidebar{width:300px;background:var(--card);padding:12px;border-radius:6px;flex:0 0 300px;box-shadow:0 0 0 1px rgba(0,0,0,0.03)}
    nav.sidebar h3{margin:0 0 8px 0}
    nav.sidebar ul{padding:0;margin:0;list-style:none}
    nav.sidebar li{margin:8px 0}
    nav.sidebar a{color:var(--link);text-decoration:none}
    main{flex:1 1 auto;min-width:0}
    header{background:var(--teal);color:#fff;padding:14px;border-radius:6px;margin-bottom:12px;font-weight:700;max-width:var(--maxw);margin-left:auto;margin-right:auto}
    .card{background:var(--card);padding:12px;border-radius:6px;margin-bottom:12px;box-shadow:0 0 0 1px rgba(0,0,0,0.03)}
    ol{padding-left:18px}
    li.item{margin:10px 0}
    .meta{color:var(--muted);font-size:0.92rem;display:block;margin-top:4px}
    .annotation{margin-top:8px;padding:8px;background:#fff9e6;border-left:3px solid #ffd166}
    .btn{display:inline-block;padding:6px 8px;border-radius:4px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    #fullView{display:none;padding:14px}
    #fullView h1{margin:0 0 8px 0;font-size:1.35rem}
    #fullView .meta{margin-bottom:12px}
    .backBtn{margin-top:12px}
    .hidden{display:none}
    #search{padding:8px;border-radius:6px;border:1px solid #ddd}
    @media(max-width:880px){.wrap{flex-direction:column}nav.sidebar{width:100%;flex:0 0 auto}}
    footer{max-width:var(--maxw);margin:8px auto;text-align:center;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <header>Irfan Portal — Essays (embedded / external) <span style="float:right;font-weight:400;font-size:0.95rem;opacity:.95">Last updated: <span id="lastUpdated">2025-11-30</span></span></header>

  <div class="wrap" role="main">
    <nav class="sidebar" aria-label="Main navigation">
      <h3>Contents</h3>
      <ul id="sidebarList">
        <!-- Filled dynamically from essays/index.json or fallback list -->
      </ul>

      <hr/>
      <div style="font-size:.95rem"><a href="#index" id="indexLink">Index</a> · <a href="#favorites" id="showFavLink">Favorites</a></div>
      <hr/>
      <div style="margin-top:8px;color:var(--muted);font-size:.95rem">
        <div><strong>Quick filter</strong></div>
        <button class="btn" data-filter="all">All</button>
        <button class="btn" data-filter="essay">Essay</button>
        <button class="btn" data-filter="translation">Translation</button>
      </div>
    </nav>

    <main>
      <div class="card" id="toolbar">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search" type="search" placeholder="Search titles, authors, keywords…" style="flex:1">
          <button id="clearSearch" class="btn">Clear</button>
          <button id="toggleAnnotations" class="btn">Toggle annotations</button>
          <button id="openGloss" class="btn">Glossary</button>
        </div>
      </div>

      <section id="listArea" class="card" aria-live="polite">
        <div style="font-weight:700;margin-bottom:8px">Essays & items (click title to preview or click "Open full" to read inline)</div>
        <ol id="items">
          <!-- Populated dynamically -->
        </ol>
      </section>

      <aside id="preview" class="card" aria-live="polite">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Article preview</div>
          <div><button id="favPreviewBtn" class="btn">☆ Favorite</button></div>
        </div>

        <div id="previewInner" style="margin-top:10px">
          <h2>Select an essay to see details</h2>
          <div class="meta">Click a title to preview; click <em>Open full</em> to read the external/embedded HTML.</div>
        </div>
      </aside>

      <article id="fullView" class="card" role="article" aria-live="polite">
        <div id="fullInner"></div>
        <div style="margin-top:12px">
          <button id="backToList" class="btn backBtn">◀ Back to list</button>
          <button id="printBtn" class="btn">Print</button>
          <button id="downloadHtmlBtn" class="btn">Download HTML</button>
        </div>
      </article>
    </main>
  </div>

  <!-- Glossary modal -->
  <div id="glossModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;padding:18px;z-index:40">
    <div style="background:#fff;padding:14px;border-radius:8px;max-width:820px;width:100%;max-height:80vh;overflow:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Glossary / 用語集</strong>
        <button id="closeGloss" class="btn">✕</button>
      </div>
      <div style="margin-top:8px">
        <input id="glossSearch" type="search" placeholder="Search glossary…" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px">
      </div>
      <ul id="glossList" style="margin-top:10px">
        <li><strong>Analytic philosophy</strong> — A tradition concerned with language, logic, and clarity of argument.</li>
        <li><strong>Irfanian</strong> — Adjective describing ideas or scholars influenced by Irfan's portal style.</li>
        <li><strong>Translation variant</strong> — Different translated renderings of the same passage.</li>
      </ul>
    </div>
  </div>

  <footer>Keep essays in an <code>essays/</code> folder and update <code>essays/index.json</code> — see instructions below.</footer>

<script>
/* CONFIG: path to essays folder and index file */
const ESSAYS_INDEX = 'essays/index.json'; // editable if you place index elsewhere
const ESSAYS_DIR = 'essays/'; // folder where essays are stored

/* UI elements */
const sidebarList = document.getElementById('sidebarList');
const itemsOl = document.getElementById('items');
const previewInner = document.getElementById('previewInner');
const fullView = document.getElementById('fullView');
const fullInner = document.getElementById('fullInner');
const favPreviewBtn = document.getElementById('favPreviewBtn');
const showFavLink = document.getElementById('showFavLink');
const STORAGE_KEY = 'irfan_portal_favs_v1';
let favorites = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

/* default fallback data (used when index.json not present) */
const FALLBACK_LIST = [
  { id:'e1', title:'Stalin: A Historical and Dialectical Necessity Undone by Khrushchev', author:'Irfan', date:'2024-01-01', filename:'stalin.html', category:'essay', annotation:'theoretical, historical, dialectical analysis.' },
  { id:'e2', title:'An Enquiry Concerning Israel, Liberal Democracy and Karl Marx', author:'Irfan', date:'2024-01-02', filename:'israel-marx.html', category:'essay', annotation:'geopolitical critique, democracy & ideology.' },
  { id:'e3', title:'On China', author:'Irfan', date:'2024-01-03', filename:'on-china.html', category:'essay', annotation:'strategic, historical, and political study.' },
  { id:'e4', title:'Ecological Motion of Capitalism', author:'Irfan', date:'2024-01-04', filename:'ecological-capitalism.html', category:'essay', annotation:'ecological critique of capitalist dynamics.' },
  { id:'e5', title:'The Illiberal Nature of Democracy', author:'Irfan', date:'2024-01-05', filename:'illiberal-democracy.html', category:'essay', annotation:'political theory, contradictions of democracy.' }
];

/* Utility: safe fetch JSON */
async function fetchJson(url){
  try {
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('Not found');
    return await res.json();
  } catch(e){
    return null;
  }
}

/* Load index.json if available; otherwise use fallback */
async function loadIndex(){
  const json = await fetchJson(ESSAYS_INDEX);
  if(json && Array.isArray(json.items)){
    return json.items;
  }
  // fallback
  return FALLBACK_LIST;
}

/* Render sidebar + list from essay metadata */
function renderLists(list){
  sidebarList.innerHTML = '';
  itemsOl.innerHTML = '';
  list.forEach((item, idx) => {
    // sidebar link
    const liNav = document.createElement('li');
    liNav.innerHTML = `<a href="#essay-${item.id}" data-id="${item.id}" class="navlink">${String(idx+1).padStart(2,'0')} — ${escapeHtml(item.title)}</a>`;
    sidebarList.appendChild(liNav);

    // main list item
    const li = document.createElement('li');
    li.className = 'item';
    li.dataset.id = item.id;
    li.dataset.category = item.category || 'essay';
    li.dataset.date = item.date || '';
    li.dataset.filename = item.filename || '';
    li.innerHTML = `${String(idx+1).padStart(2,'0')} ) <a href="#essay-${item.id}" class="openTitle">${escapeHtml(item.title)}</a>
      <span class="meta">— ${escapeHtml(item.author || '')}</span>
      <div class="annotation hidden">${escapeHtml(item.annotation || '')}</div>`;
    itemsOl.appendChild(li);
  });

  // wire link clicks (delegated)
  document.querySelectorAll('.openTitle, .navlink').forEach(a=>{
    a.addEventListener('click', (e)=>{
      // allow hashchange routing to handle preview/full
      // prevent default? no — let hash change happen
    });
  });

  // show first preview
  const first = itemsOl.querySelector('.item');
  if(first) renderPreview(first);
}

/* Render preview from a list element (li DOM) */
function renderPreview(li){
  const title = li.querySelector('.openTitle').textContent;
  const meta = li.querySelector('.meta').textContent;
  const annotation = li.querySelector('.annotation').innerHTML;
  previewInner.innerHTML = `
    <h2>${title}</h2>
    <div class="meta">${meta} — <em>${li.dataset.date}</em></div>
    <p style="margin-top:10px">Short summary: Replace this placeholder with the essay blurb or update the essay HTML file.</p>
    <div style="margin-top:10px"><strong>Annotation</strong><div class="annotation">${annotation}</div></div>
    <div class="actions">
      <button class="btn" id="openFullBtn">Open full</button>
      <button class="btn" id="copyCite">Copy citation</button>
    </div>
  `;
  document.getElementById('openFullBtn').onclick = () => {
    location.hash = 'full-' + li.dataset.id;
  };
  document.getElementById('copyCite').onclick = () => {
    const cite = `${title}. ${meta} (${li.dataset.date})`;
    navigator.clipboard?.writeText(cite).then(()=> alert('Citation copied to clipboard.'));
  };
  favPreviewBtn.textContent = (favorites.includes(li.dataset.id) ? '★ Favorited' : '☆ Favorite');
}

/* Hash routing */
async function handleHash(){
  const h = location.hash.replace('#','');
  if(!h || h === 'index'){
    fullView.style.display = 'none';
    const firstLi = itemsOl.querySelector('.item');
    if(firstLi) renderPreview(firstLi);
    return;
  }
  if(h.startsWith('essay-')){
    const id = h.replace('essay-','');
    const li = itemsOl.querySelector(`.item[data-id="${id}"]`);
    if(li) {
      renderPreview(li);
      fullView.style.display = 'none';
    }
    return;
  }
  if(h.startsWith('full-')){
    const id = h.replace('full-','');
    const li = itemsOl.querySelector(`.item[data-id="${id}"]`);
    if(li){
      renderPreview(li);
      await showFullFromMeta(li.dataset.filename, li);
    } else {
      // try to find in sidebar links
      alert('Essay not found in index.');
    }
    return;
  }
  if(h === 'favorites'){
    showFavorites();
    fullView.style.display = 'none';
    return;
  }
}

/* Fetch and display an essay file (filename relative to ESSAYS_DIR) */
async function showFullFromMeta(filename, liElement){
  if(!filename){
    fullInner.innerHTML = `<h1>Not configured</h1><p class="meta">This essay has no filename set in index.json.</p>`;
    fullView.style.display = 'block';
    window.scrollTo({top:0,behavior:'smooth'});
    return;
  }
  try {
    const url = ESSAYS_DIR + filename;
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to load essay file.');
    const html = await res.text();
    // sanitize minimal: we'll inject inside container — recommend authors keep essay HTML small and valid
    fullInner.innerHTML = html;
  } catch(e){
    fullInner.innerHTML = `<h1>Unable to load essay</h1><p class="meta">${escapeHtml(String(e.message))}</p>`;
  }
  fullView.style.display = 'block';
  window.scrollTo({top:0,behavior:'smooth'});
}

/* Back to list */
document.getElementById('backToList').addEventListener('click', ()=>{
  location.hash = 'index';
});

/* Print */
document.getElementById('printBtn').addEventListener('click', ()=> {
  const html = `<!doctype html><html><head><meta charset="utf-8"><title>Print</title></head><body>${fullInner.innerHTML}</body></html>`;
  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.print();
});

/* Download current full HTML */
document.getElementById('downloadHtmlBtn').addEventListener('click', ()=>{
  const blob = new Blob([fullInner.innerHTML], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'essay.html';
  a.click();
  URL.revokeObjectURL(a.href);
});

/* Favorite toggle */
favPreviewBtn.addEventListener('click', ()=>{
  const h2 = previewInner.querySelector('h2');
  if(!h2) return alert('Select an essay first.');
  const title = h2.textContent;
  const li = Array.from(itemsOl.querySelectorAll('.item')).find(it => it.querySelector('.openTitle').textContent === title);
  if(!li) return;
  const id = li.dataset.id;
  if(favorites.includes(id)) favorites = favorites.filter(x => x !== id);
  else favorites.push(id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(favorites));
  renderPreview(li);
});

/* Show favorites */
function showFavorites(){
  if(favorites.length === 0){
    previewInner.innerHTML = '<h2>Favorites</h2><p class="meta">No favorites yet. Use the ☆ Favorite button in the preview to add items.</p>';
    return;
  }
  const favItems = Array.from(itemsOl.querySelectorAll('.item')).filter(it => favorites.includes(it.dataset.id));
  let html = '<h2>Favorites</h2><ol>';
  favItems.forEach(it => {
    const title = it.querySelector('.openTitle').textContent;
    const meta = it.querySelector('.meta').textContent;
    html += `<li><a href="#essay-${it.dataset.id}">${escapeHtml(title)}</a><div class="meta">${escapeHtml(meta)}</div></li>`;
  });
  html += '</ol>';
  previewInner.innerHTML = html;
}

/* Search/filter */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  Array.from(itemsOl.querySelectorAll('.item')).forEach(li => {
    li.style.display = (li.textContent.toLowerCase().includes(q)) ? '' : 'none';
  });
});
document.getElementById('clearSearch').addEventListener('click', ()=>{
  document.getElementById('search').value = '';
  Array.from(itemsOl.querySelectorAll('.item')).forEach(li => li.style.display = '');
});

/* Toggle annotations */
document.getElementById('toggleAnnotations').addEventListener('click', ()=>{
  Array.from(itemsOl.querySelectorAll('.item')).forEach(li => {
    const a = li.querySelector('.annotation');
    if(a) a.classList.toggle('hidden');
  });
});

/* Quick filter buttons */
document.querySelectorAll('nav.sidebar button[data-filter]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const f = btn.dataset.filter;
    Array.from(itemsOl.querySelectorAll('.item')).forEach(li => {
      li.style.display = (f === 'all' || li.dataset.category === f) ? '' : 'none';
    });
  });
});

/* Glossary modal */
const glossModal = document.getElementById('glossModal');
document.getElementById('openGloss').addEventListener('click', ()=> glossModal.style.display = 'flex');
document.getElementById('closeGloss').addEventListener('click', ()=> glossModal.style.display = 'none');
document.getElementById('glossSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  document.querySelectorAll('#glossList li').forEach(li=> li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none');
});

/* Favorites link */
document.getElementById('showFavLink').addEventListener('click', (e)=> { e.preventDefault(); location.hash = 'favorites'; });

/* Utility: escape text for insertion into HTML (minimal) */
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

/* Initialize app: load index and render */
(async function init(){
  const list = await loadIndex();
  renderLists(list);
  // wire hash routing
  window.addEventListener('hashchange', handleHash);
  if(!location.hash) {
    const first = itemsOl.querySelector('.item');
    if(first) renderPreview(first);
  } else {
    handleHash();
  }
})();
</script>
</body>
</html>
